<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>ä¸­å€æ”¶é€ä»¶é€²åº¦è¿½è¹¤ç³»çµ± (v68 Final Stable)</title>

    <script src="https://unpkg.com/firebase@9.22.2/firebase-app-compat.js"></script>
    <script src="https://unpkg.com/firebase@9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/firebase@9.22.2/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary: #0f766e; --primary-light: #ccfbf1; --bg: #f3f4f6;
            --sidebar-bg: #ffffff; --text-main: #111827; --text-light: #6b7280;
            --border: #e5e7eb; --danger: #ef4444; --success: #10b981; --warning: #f59e0b;
            --genesis: #7e22ce; --line-green: #06c755; --blue: #2563eb;
            --assign-bg: #4338ca;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .auth-box { background: white; padding: 2.5rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 320px; text-align: center; border: 1px solid var(--border); position: relative; }
        .auth-box input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; }
        .auth-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: 600; font-size: 1rem; transition: background 0.3s; }
        .auth-btn:disabled { background: #9ca3af; cursor: not-allowed; }
        .switch-auth { margin-top: 15px; font-size: 0.9rem; color: var(--text-light); cursor: pointer; text-decoration: underline; }

        /* Layout Structure */
        #app-screen { display: flex; width: 100%; height: 100%; position: relative; }
        
        aside { 
            width: 280px; 
            min-width: 280px; 
            flex-shrink: 0; 
            background: var(--sidebar-bg); 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            box-sizing: border-box; 
            transition: transform 0.3s ease; 
            padding: 0; 
            z-index: 50; 
        }
        
        .sidebar-fixed { padding: 1.5rem 1.5rem 0.5rem 1.5rem; flex-shrink: 0; background: var(--sidebar-bg); z-index: 10; border-bottom: 1px solid #f3f4f6; }
        .sidebar-scroll { padding: 1rem 1.5rem 1.5rem 1.5rem; flex-grow: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
        .sidebar-scroll::-webkit-scrollbar { width: 5px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        
        #mobile-menu-btn { display: none; position: absolute; top: 15px; left: 15px; z-index: 1100; background: white; border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 1.5rem; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); color: var(--primary); }
        #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 900; backdrop-filter: blur(2px); }
        
        .user-profile { display: flex; align-items: center; gap: 10px; padding-bottom: 1.5rem; margin-bottom: 0.5rem; }
        .avatar { width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; }
        .logout-link { font-size: 0.8rem; color: var(--danger); cursor: pointer; margin-top: 2px;}
        
        .sidebar-btn { padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; font-weight: 600; margin-bottom: 10px; display: block; font-size: 0.9rem; border: 1px solid transparent; width: 100%; white-space: nowrap; }
        .sidebar-btn:hover { opacity: 0.9; }
        .btn-nav-active { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-nav-inactive { background: white; color: var(--text-light); border: 1px solid var(--border); }
        
        .admin-btn { padding: 10px; border-radius: 6px; text-align: center; cursor: pointer; font-weight: 600; margin-bottom: 10px; display: none; font-size: 0.9rem; white-space: nowrap; }
        .btn-perm { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; }
        .btn-stats { background: #eff6ff; color: #1d4ed8; border: 1px solid #dbeafe; }
        .btn-settings { background: #f0fdfa; color: #0f766e; border: 1px solid #ccfbf1; } 
        .btn-import { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .btn-client-search { background: #f0f9ff; color: #0369a1; border: 1px solid #bae6fd; }
        .btn-assign-settings { background: #eef2ff; color: #4338ca; border: 1px solid #c7d2fe; }
        .btn-purchase { background: #fdf4ff; color: #86198f; border: 1px solid #f0abfc; }

        .sidebar-section h3 { font-size: 0.85rem; text-transform: uppercase; color: var(--text-light); letter-spacing: 1px; margin-bottom: 1rem; }
        input[type="date"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; color: var(--text-main); box-sizing: border-box; font-family: inherit; }
        
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; margin-bottom: 5px; font-size: 0.9rem; }
        .search-results { list-style: none; padding: 0; margin: 0; max-height: 250px; overflow-y: auto; background: white; border: 1px solid #eee; border-radius: 6px; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .search-item { padding: 10px; font-size: 0.85rem; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; flex-direction: column; gap: 2px; }
        .search-item:hover { background: #f0fdfa; color: var(--primary); }
        .search-item:last-child { border-bottom: none; }

        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .history-item { padding: 10px; cursor: pointer; border-radius: 6px; color: var(--text-main); margin-bottom: 4px; display: flex; justify-content: space-between; }
        .history-item:hover { background: #f8fafc; }
        .history-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }

        main { flex-grow: 1; padding: 2rem; overflow-y: auto; overflow-x: auto; position: relative; min-width: 0; }
        .view-section { display: none; height: 100%; flex-direction: column; }
        .view-section.active { display: flex; }

        /* Task View Styles */
        header { margin-bottom: 2rem; }
        header h1 { margin: 0; font-size: 1.8rem; color: #111827; }
        .date-header { color: var(--text-light); margin-bottom: 0.5rem; font-weight: 500; }
        .overall-progress-container { margin-top: 15px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb; }
        .progress-label { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; font-weight: 600; color: #4b5563; }
        .progress-track { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: width 0.5s ease; }

        .task-container { max-width: 900px; padding-bottom: 100px; }
        .category-group { margin-bottom: 2.5rem; }
        .category-header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem; }
        .cat-title { color: var(--primary); font-weight: 700; font-size: 1.1rem; display: flex; align-items: center; }
        .badge-count { background: #e5e7eb; color: #374151; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; }
        .cat-progress-track { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden; margin-bottom: 1rem; }
        .cat-progress-fill { height: 100%; background: var(--primary); transition: width 0.5s ease; }

        details { margin-bottom: 10px; border: 1px solid #e5e7eb; border-radius: 6px; overflow: hidden; background: white; }
        details summary { padding: 12px; cursor: pointer; font-weight: 600; background: #f9fafb; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        .details-content { padding: 10px; background: #fff; }
        .category-group.overdue-section .cat-title { color: #dc2626; } 
        
        .task-item { background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.8rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: flex-start; transition: all 0.2s; border-left: 4px solid transparent; position: relative; }
        .task-item:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-1px); }
        .task-item[data-cat="å®šåºæ”¶ä»¶"] { border-left-color: #3b82f6; }
        .task-item[data-cat="å¼•å­é€ä»¶"] { border-left-color: #8b5cf6; }
        .task-item[data-cat="ç”¢å‰æ”¶ä»¶"] { border-left-color: #ec4899; }
        .task-item[data-cat="æ¥­å‹™äº¤è¾¦äº‹é …"] { border-left-color: #f59e0b; }
        .task-item[data-cat="NGSæ”¶ä»¶"] { border-left-color: #0d9488; }
        .task-item.overdue-item { animation: blink-alert 2s infinite ease-in-out; border-left-width: 6px; }
        @keyframes blink-alert { 0% { border-left-color: #ef4444; } 50% { border-left-color: #b91c1c; } 100% { border-left-color: #ef4444; } }
        
        .task-checkbox { width: 22px; height: 22px; border: 2px solid #cbd5e1; border-radius: 5px; margin-right: 15px; cursor: pointer; flex-shrink: 0; display: grid; place-items: center; margin-top: 3px; }
        .task-checkbox:hover { border-color: var(--primary); }
        .task-content { flex-grow: 1; display: flex; flex-direction: column; padding-right: 10px; }
        .task-title { font-size: 1rem; line-height: 1.5; word-break: break-all; padding: 2px 4px; border-radius: 4px; cursor: pointer; display: flex; flex-wrap: wrap; align-items: center; }
        .task-meta { font-size: 0.8rem; color: var(--text-light); margin-top: 6px; line-height: 1.4; }
        .completed-info { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 4px; display: inline-block; font-weight: 500; }
        .task-item.completed-item .task-title { color: #9ca3af; text-decoration: line-through; }
        .ngs-badge { display: inline-block; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #ccc; background: #fdfdfd; margin-right: 5px; margin-top: 3px; color: #555; }
        
        .assign-badge { display: inline-block; font-size: 0.95rem; background-color: var(--assign-bg); color: white; padding: 4px 10px; border-radius: 6px; margin-left: 10px; vertical-align: middle; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.3); white-space: nowrap; letter-spacing: 0.5px; border: 1px solid #312e81; }

        .action-area { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .btn-icon { background: none; border: 1px solid transparent; cursor: pointer; font-size: 1.2rem; padding: 2px 6px; color: #9ca3af; border-radius: 4px; }
        .btn-icon:hover { background-color: #f3f4f6; color: var(--text-main); border-color: #ddd; }
        .btn-delete:hover { color: var(--danger); }
        .btn-restore { color: var(--success); font-size: 1rem; }
        .btn-line:hover { color: var(--line-green); }
        .btn-copy:hover { color: var(--primary); }
        .btn-assign:hover { color: var(--assign-bg); background: #e0e7ff; }
        .fab { position: fixed; bottom: 2rem; right: 2rem; width: 60px; height: 60px; background: var(--primary); color: white; border-radius: 50%; font-size: 32px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: transform 0.2s; z-index: 800; }
        .fab:hover { transform: scale(1.05); background: #0d9488; }

        /* Client Search Styles */
        .cust-header { margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .cust-search-bar { flex-grow: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; }
        .btn-google-form { background: #4285F4; color: white; padding: 10px 15px; border-radius: 6px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border:none; cursor:pointer;}
        .btn-google-form:hover { background: #357ae8; }
        .cust-list-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .cust-card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-top: 4px solid var(--blue); transition: transform 0.2s; display: flex; flex-direction: column; gap: 6px; }
        .cust-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .cust-title-row { font-size: 1.2rem; font-weight: 800; color: #111827; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 4px; }
        .cust-row { font-size: 1rem; color: #374151; display: flex; align-items: flex-start; gap: 6px; line-height: 1.5; }
        .cust-row.note { color: #6b7280; font-style: italic; font-size: 0.9rem; background: #f9fafb; padding: 8px; border-radius: 4px; margin-top: 5px; }
        .cust-update { font-size: 0.75rem; color: #9ca3af; text-align: right; margin-top: auto; padding-top: 10px; border-top: 1px dashed #eee; }
        .loading-spinner { text-align: center; padding: 20px; font-size: 1.2rem; color: var(--primary); }

        /* Modals & Others */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2100; justify-content: center; align-items: center; }
        .modal-card { background: white; padding: 2rem; border-radius: 12px; width: 500px; max-width: 90%; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 90vh; overflow-y: auto; }
        .editor-toolbar { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; padding: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-bottom: none; border-radius: 6px 6px 0 0; align-items: center; }
        .tool-btn { padding: 4px 8px; border: 1px solid #cbd5e1; background: white; border-radius: 4px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; margin-bottom: 4px;}
        .color-dot { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid #ddd; }
        .separator { width: 1px; height: 20px; background: #cbd5e1; margin: 0 4px; }
        select.tool-select { padding: 4px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.85rem; }
        #inputTitle { width: 100%; min-height: 80px; padding: 15px; border: 1px solid #d1d5db; border-radius: 0 0 6px 6px; box-sizing: border-box; font-size: 1rem; background: white; outline: none; overflow-y: auto; }
        #inputTitle:focus { border-color: var(--primary); }
        .input-group { margin-bottom: 1.2rem; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; }
        .input-group select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; }
        .input-group input[type="text"] { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        #ngs-form-container { background: #f0fdfa; padding: 15px; border: 1px solid #ccfbf1; border-radius: 8px; margin-bottom: 15px; display: none; }
        .ngs-row { margin-bottom: 10px; }
        .ngs-row label { font-size: 0.85rem; color: #0f766e; font-weight: 600; margin-bottom: 4px; display: block; }
        .ngs-row input, .ngs-row select { width: 100%; padding: 8px; border: 1px solid #5eead4; border-radius: 4px; font-size: 0.95rem; }
        #ngs-extraction-fields, #ngs-qc-fields { margin-top: 10px; padding-left: 10px; border-left: 3px solid #0d9488; display: none; }
        #importTextarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; font-size: 0.9rem; white-space: pre; overflow: auto; }
        .import-guide { font-size: 0.85rem; color: #666; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px solid #eee; }
        .modal-btns { display: flex; justify-content: flex-end; gap: 12px; margin-top: 1.5rem; }
        .btn { padding: 9px 18px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.95rem; }
        .btn-cancel { background: #f3f4f6; color: #4b5563; }
        .btn-save { background: var(--primary); color: white; }

        /* User List and Settings Styles */
        .user-list, .settings-list, .assign-list { list-style: none; padding: 0; margin: 0; }
        .user-item { display: flex; flex-direction: column; padding: 15px; border: 1px solid #eee; background: white; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: 0.2s; }
        .user-item:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.05); transform: translateY(-1px); }
        .user-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .user-name { font-weight: 700; font-size: 1.05rem; color: #1f2937; }
        .user-role-badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; margin-left: 8px; border: 1px solid #ddd; font-weight: 500; }
        .role-creator { background: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; }
        .role-senior { background: #fef3c7; color: #b45309; border-color: #fcd34d; }
        .role-admin { background: #e0f2fe; color: #0369a1; border-color: #7dd3fc; }
        .role-user { background: #f3f4f6; color: #4b5563; border-color: #d1d5db; }
        .user-edit-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        .user-edit-row input, .user-edit-row select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
        
        .settings-container { margin-top: 15px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        
        /* Assignment Settings */
        .assign-section { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 6px; background: #fafafa; }
        .assign-sec-title { font-weight: bold; margin-bottom: 8px; color: var(--primary); font-size: 0.95rem; }
        .assign-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .assign-check-item { display: flex; align-items: center; font-size: 0.9rem; background: white; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .assign-check-item:hover { border-color: var(--primary); }
        .assign-check-item input { margin-right: 6px; }

        @media (max-width: 768px) {
            #mobile-menu-btn { display: block; }
            #sidebar-overlay { display: none; }
            #sidebar-overlay.active { display: block; }
            aside { position: fixed; top: 0; left: 0; height: 100%; width: 280px; z-index: 1000; transform: translateX(-100%); box-shadow: 2px 0 10px rgba(0,0,0,0.1); }
            aside.open { transform: translateX(0); }
            main { padding-top: 70px; width: 100%; }
            .task-item { flex-direction: column; }
            .task-content { padding-right: 0; margin-bottom: 10px; }
            .action-area { flex-direction: row; width: 100%; justify-content: flex-end; }
            .fab { bottom: 20px; right: 20px; width: 50px; height: 50px; font-size: 28px; }
            .cust-header { flex-direction: column; align-items: stretch; }
        }

        /* --- PURCHASING SYSTEM STYLES (SCOPED) --- */
        #purchaseView .pur-toolbar-row { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;}
        #purchaseView .pur-toolbar-left { display: flex; gap: 10px; align-items: center; }
        #purchaseView .pur-btn-base { border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: bold; transition: 0.2s; }
        #purchaseView .pur-btn-lg { padding: 10px 20px; font-size: 15px; }
        #purchaseView .pur-btn-sm { padding: 4px 8px; font-size: 13px; color: white; white-space: nowrap; } 
        
        #purchaseView .pur-btn-add { background-color: #e67e22; color: white; } #purchaseView .pur-btn-add:hover { background-color: #d35400; }
        #purchaseView .pur-btn-filter { background-color: #34495e; color: white; } #purchaseView .pur-btn-filter:hover { background-color: #2c3e50; }
        #purchaseView .pur-btn-action { background-color: #3498db; color:white; } #purchaseView .pur-btn-action:hover { background-color: #2980b9; }
        #purchaseView .pur-btn-final { background-color: #27ae60; color:white; } #purchaseView .pur-btn-final:hover { background-color: #219150; }
        #purchaseView .pur-btn-modify { background-color: #f39c12; color:white; } #purchaseView .pur-btn-modify:hover { background-color: #d68910; }
        #purchaseView .pur-btn-delete { background-color: #c0392b; color:white; } #purchaseView .pur-btn-delete:hover { background-color: #a93226; }
        #purchaseView .pur-btn-restore { background-color: #2ecc71; color:white; } #purchaseView .pur-btn-restore:hover { background-color: #27ae60; }
        #purchaseView .pur-btn-revert { background-color: #7f8c8d; color:white; } #purchaseView .pur-btn-revert:hover { background-color: #616a6b; }
        #purchaseView .pur-btn-note { background-color: #6c5ce7; color: white; } #purchaseView .pur-btn-note:hover { background-color: #5b4cc4; }

        #purchaseView table { width: 100%; border-collapse: collapse; margin-top: 10px; table-layout: fixed; }
        #purchaseView th { background-color: #2c3e50; color: white; padding: 12px; text-align: center; white-space: nowrap; border: 1px solid #ddd;}
        #purchaseView td { padding: 8px; border: 1px solid #ddd; text-align: center; vertical-align: middle; background:white; }
        #purchaseView tr:nth-child(even) td { background-color: #fcfcfc; }
        
        /* Adjusted Column Widths (Fixed) */
        #purchaseTable th:nth-child(4) { width: auto; min-width: 135px; } /* PUR Info: Flexible */
        #purchaseTable th:last-child { width: 210px; } /* Actions: Fit 4 buttons */

        #purchaseView .pur-badge { display: flex; width: 100%; height: 100%; align-items: center; justify-content: center; color: white; font-size: 16px; font-weight: bold; border-radius: 4px; padding:5px; }
        #purchaseView .st-new { background-color: #95a5a6; } 
        #purchaseView .st-pur { background-color: #17a2b8; } 
        #purchaseView .st-sap { background-color: #6f42c1; } 
        #purchaseView .st-ordered { background-color: #28a745; } 
        #purchaseView .st-cancel { background-color: #d63031; }
        
        #purchaseView .row-cancelled { color: #aaa !important; background-color: #f0f0f0 !important; }
        #purchaseView .row-cancelled td { background-color: #f0f0f0 !important; color: #aaa !important;}
        #purchaseView .row-cancelled strong { text-decoration: line-through; }
        
        .pur-active-filter { background: #dff9fb; color: #22a6b3; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; display: none;}
        
        /* Tooltip & Note Icon */
        .tooltip-container { position: relative; display: inline-flex; align-items: center; gap: 5px; cursor: pointer; color: #555; font-size: 18px; justify-content: center; }
        .tooltip-container .tooltip-text { visibility: hidden; width: 300px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 100; top: -10px; left: 120%; opacity: 0; transition: opacity 0.3s; font-size: 12px; line-height: 1.5; white-space: pre-wrap; box-shadow: 2px 2px 10px rgba(0,0,0,0.3); }
        .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }
        
        .note-icon {
            display: inline-flex; justify-content: center; align-items: center;
            width: 20px; height: 20px;
            background-color: #e74c3c; color: white;
            border-radius: 50%;
            font-size: 14px; font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            cursor: help;
        }

        /* BATCH BUTTONS & INPUTS (UI FIXED) */
        .pur-btn-add { background-color: #38bdf8 !important; color: white; font-size: 16px !important; padding: 8px 16px !important; border: none; border-radius: 6px !important; cursor: pointer; font-weight: bold; }
        .pur-btn-add:hover { background-color: #0ea5e9 !important; }
        
        .pur-batch-field { width: 100% !important; display: block; margin-bottom: 10px; box-sizing: border-box; }
        
        .pur-input-group { margin-bottom: 15px; text-align: left; width: 100%; }
        .pur-input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .pur-input-group input, .pur-input-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
    </style>
</head>
<body>

<button id="mobile-menu-btn" onclick="toggleSidebar()">â˜°</button>
<div id="sidebar-overlay" onclick="toggleSidebar()"></div>

<div id="auth-screen">
    <div class="auth-box" id="authBox">
        <h2 id="auth-title" style="color:#0f766e">ç³»çµ±ç™»å…¥</h2>
        <input type="text" id="username" placeholder="å¸³è™Ÿ" autofocus>
        <input type="password" id="password" placeholder="å¯†ç¢¼">
        <button class="auth-btn" id="btnAuthAction" onclick="handleAuth()">ç™»å…¥</button>
        <div class="switch-auth" id="switchAuthLink" onclick="toggleAuthMode()">æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ</div>
    </div>
</div>

<div id="app-screen" style="display:none;">
    <aside>
        <div class="sidebar-fixed">
            <div class="user-profile">
                <div class="avatar" id="userAvatar">U</div>
                <div>
                    <div style="font-weight: 600;" id="displayUsername">User</div>
                    <div class="logout-link" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</div>
                </div>
            </div>
            
            <button class="sidebar-btn btn-nav-active" id="btnTabTasks" onclick="switchTab('tasks')">ğŸ“‹ ä»»å‹™çœ‹æ¿</button>
            <button class="sidebar-btn btn-client-search" id="btnTabCustomers" onclick="switchTab('customers')">ğŸ¢ å®¢æˆ¶ä½ç½®æŸ¥è©¢</button>
            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
        </div>

        <div class="sidebar-scroll">
            <div class="admin-btn btn-purchase" id="purchaseBtn" onclick="switchTab('purchase')" style="display:none;">ğŸ“¦ QIAGEN æ¡è³¼é€²åº¦</div>
            <div class="admin-btn btn-perm" id="adminPanelBtn" onclick="openUserModal()">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</div>
            <div class="admin-btn btn-settings" id="salesSettingsBtn" onclick="openSalesSettings()">âš™ï¸ æ¨™ç±¤é¸å–®å¾Œå°è¨­å®š</div>
            <div class="admin-btn btn-assign-settings" id="assignSettingsBtn" onclick="openAssignSettingsModal()">ğŸ‘¤ æŒ‡æ´¾ä»»å‹™å¸³è™Ÿè¨­å®š</div>
            <div class="admin-btn btn-import" id="importBtn" onclick="openImportModal()">ğŸ“¥ æ‰¹é‡åŒ¯å…¥ä»»å‹™</div>
            <div class="admin-btn btn-stats" id="statsPanelBtn" onclick="openStatsModal()">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</div>
            
            <div class="sidebar-section" id="taskSearchSection">
                <h3>ğŸ” æœå°‹ä»»å‹™</h3>
                <div class="search-box">
                    <input type="text" id="searchTaskInput" placeholder="è¼¸å…¥é—œéµå­—..." oninput="handleSearch()">
                    <ul class="search-results" id="searchResults"></ul>
                </div>
            </div>

            <div class="sidebar-section" id="taskDateSection">
                <h3>ğŸ“… æ—¥æœŸé¸æ“‡</h3>
                <input type="date" id="dateSearch" onchange="changeDate(this.value)">
            </div>
            
            <div class="sidebar-section" style="margin-top:20px;">
                <h3>ğŸ•’ æœ€è¿‘æª¢è¦–ç´€éŒ„</h3>
                <ul class="history-list" id="historyList"></ul>
            </div>
        </div>
    </aside>

    <main>
        <div id="taskView" class="view-section active">
            <header>
                <div class="date-header" id="headerDateDisplay"></div>
                <h1>ä¸­å€æ”¶é€ä»¶å³æ™‚é€²åº¦</h1>
                <div class="overall-progress-container">
                    <div class="progress-label"><span>ç•¶æ—¥ç¸½å®Œæˆåº¦</span><span id="overallProgressText">0%</span></div>
                    <div class="progress-track"><div class="progress-fill" id="overallProgressBar" style="width: 0%"></div></div>
                </div>
            </header>
            <div class="task-container" id="taskListContainer"></div>
            <button class="fab" onclick="openModal()">+</button>
        </div>

        <div id="customerView" class="view-section">
            <header>
                <h1>å®¢æˆ¶ä½ç½®æŸ¥è©¢</h1>
                <div class="date-header">ä½ç½®å³æ™‚æŸ¥è©¢ç³»çµ±</div>
            </header>
            <div class="cust-header">
                <input type="text" id="custSearchInput" class="cust-search-bar" placeholder="è¼¸å…¥å®¢æˆ¶åç¨±ã€æ¨“å±¤æˆ–é—œéµå­—..." oninput="handleCustomerSearch()">
                <a href="https://docs.google.com/forms/d/e/1FAIpQLSeeq6mOlxQW88SQQGeZA_N9HDnAl_kGlr4Y50n6oqPw5JrKvg/viewform?usp=dialog" target="_blank" class="btn-google-form">â• ç”³è«‹æ–°å¢/ä¿®æ”¹</a>
            </div>
            <div id="custLoading" class="loading-spinner" style="display:none;">
                â³ è³‡æ–™è®€å–ä¸­...
            </div>
            <div class="cust-list-container" id="customerList">
                <div style="grid-column: 1/-1; text-align:center; color:#9ca3af; margin-top:50px;">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æŸ¥è©¢</div>
            </div>
        </div>

        <div id="purchaseView" class="view-section">
            <header>
                 <h1>ä¸­å€ QIAGEN æ¡è³¼æµç¨‹é€²åº¦è¡¨</h1>
                 <div class="pur-toolbar-row">
                    <div class="pur-toolbar-left">
                        <button class="pur-btn-base pur-btn-lg" style="background:#e67e22;color:white;" onclick="PurchaseController.openModal('add')">â• æ–°å¢æ¡è³¼</button>
                        <button class="pur-btn-base pur-btn-lg" style="background:#34495e;color:white;" onclick="PurchaseController.openModal('filter')">âš¡ ç¯©é¸æ¢ä»¶</button>
                        <span id="purActiveFilterDisplay" class="pur-active-filter"></span>
                    </div>
                    <div>
                        <input type="text" id="purSearchInput" class="cust-search-bar" style="width:250px;" placeholder="ğŸ” æœå°‹å–®è™Ÿ..." onkeyup="PurchaseController.renderTable()">
                    </div>
                 </div>
            </header>
            <table id="purchaseTable">
                <thead>
                    <tr>
                        <th style="width: 100px;">å»ºç«‹æ—¥æœŸ</th>
                        <th style="width: 60px;">ç´€éŒ„</th>
                        <th style="width: 140px;">è¨‚å–®/åº«å­˜ç·¨è™Ÿ</th>
                        <th>PUR å–®è™Ÿè³‡è¨Š</th>
                        <th style="width: 120px;">SAP å–®è™Ÿè³‡è¨Š</th>
                        <th style="width: 120px;">æœ€çµ‚ä¸‹å–®ç¢ºèª</th>
                        <th style="width: 100px;">ç‹€æ…‹</th>
                        <th style="width: 210px;">åŸ·è¡Œæ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="purTableBody"></tbody>
            </table>
        </div>
    </main>
</div>

<div class="modal-overlay" id="importModal">
    <div class="modal-card" style="width: 500px;">
        <h3 style="margin-top:0; color:#047857;">ğŸ“¥ ç°¡æ˜“æ‰¹é‡åŒ¯å…¥</h3>
        <div class="import-guide">è«‹å°‡ Excel ä¸­çš„ä»»å‹™åç¨±è¤‡è£½ï¼Œä¸¦è²¼åœ¨ä¸‹æ–¹ (ä¸€è¡Œä¸€ç­†)ã€‚</div>
        <textarea id="importTextarea" placeholder="ç¯„ä¾‹ï¼š&#10;å°å¤§é†«é™¢-é™³æ•™æˆ-WESæ”¶ä»¶&#10;é•·åºšé†«é™¢-æ—é†«å¸«-DNAèƒå–"></textarea>
        <div style="margin-top:15px;"><label style="font-weight:bold;">åŒ¯å…¥è‡³å“ªå€‹é …ç›®ï¼š</label><select id="importCategorySelect" style="width:100%; padding:8px; margin-top:5px; border-radius:4px; border:1px solid #ccc;"></select></div>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('importModal').style.display='none'">å–æ¶ˆ</button><button class="btn btn-save" onclick="processImport()">ç¢ºèªåŒ¯å…¥</button></div>
    </div>
</div>

<div class="modal-overlay" id="taskModal"><div class="modal-card"><h2 id="modalTitle" style="margin-top:0; color:#111827;">æ–°å¢æ¡ˆä»¶/ä»»å‹™</h2><div class="input-group"><label>æ­¸å±¬é …ç›®</label><select id="inputCategory" onchange="handleCategoryChange()"><option value="å®šåºæ”¶ä»¶">ğŸ“‚ å®šåºæ”¶ä»¶</option><option value="å¼•å­é€ä»¶">ğŸš€ å¼•å­é€ä»¶</option><option value="ç”¢å‰æ”¶ä»¶">ğŸ“¦ ç”¢å‰æ”¶ä»¶</option><option value="æ¥­å‹™äº¤è¾¦äº‹é …">ğŸ“‹ æ¥­å‹™äº¤è¾¦äº‹é …</option><option value="NGSæ”¶ä»¶">ğŸ§¬ NGS æ”¶ä»¶ (éœ€å¡«è©³ç´°è³‡æ–™)</option></select></div><div id="ngs-form-container"><h4 style="margin-top:0; color:#0f766e;">ğŸ“ NGS è©³ç´°è³‡æ–™ (å¿…å¡«)</h4><div class="ngs-row"><label>1. å–®ä½</label><input type="text" id="ngsUnit" placeholder="è¼¸å…¥å–®ä½" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>2. ä¸»æŒäºº</label><input type="text" id="ngsPI" placeholder="è¼¸å…¥ä¸»æŒäºº" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>3. æ¨£æœ¬è™•ç†éœ€æ±‚</label><select id="ngsNeeds" onchange="handleNgsNeedsChange(); generateNgsTitle()"><option value="">è«‹é¸æ“‡</option><option value="èƒå–">èƒå– (Extraction)</option><option value="QC">QC</option></select></div><div id="ngs-extraction-fields"><div class="ngs-row"><label>4-1.1 æª¢é«”ç¨®é¡</label><select id="ngsSampleTypeSelect" onchange="handleDropdownChange('ngsSampleTypeSelect', 'ngsSampleTypeInput')"><option value="Cell">Cell</option><option value="Blood">Blood</option><option value="Tissue">Tissue</option><option value="Plant">Plant</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsSampleTypeInput" placeholder="è«‹è¼¸å…¥æª¢é«”ç¨®é¡" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-1.2 ä¿å­˜æº«åº¦</label><select id="ngsTemp"><option value="å¸¸æº«">å¸¸æº«</option><option value="4Â°C">4Â°C</option><option value="-20Â°C">-20Â°C</option><option value="-80Â°C">-80Â°C</option></select></div><div class="ngs-row"><label>4-1.3 æ­¸é‚„</label><select id="ngsReturn"><option value="æ˜¯">æ˜¯</option><option value="å¦">å¦</option></select></div><div class="ngs-row"><label>4-1.4 æ¨£æœ¬æ•¸é‡</label><input type="text" id="ngsCount" placeholder="å¡«å¯«æ•¸é‡"></div><div class="ngs-row"><label>4-1.5 å¾ŒçºŒå¯¦é©—ç¨®é¡</label><select id="ngsExpTypeSelect" onchange="handleDropdownChange('ngsExpTypeSelect', 'ngsExpTypeInput'); generateNgsTitle()"><option value="">è«‹é¸æ“‡</option><option value="Seq Only">Seq Only</option><option value="DGE">DGE</option><option value="Small RNA">Small RNA</option><option value="WES">WES</option><option value="WGS">WGS</option><option value="PIPseq">PIPseq</option><option value="Amplicon Sequence">Amplicon Sequence</option><option value="ç´°èŒWGS">ç´°èŒWGS</option><option value="metagenome">metagenome</option><option value="16s">16s</option><option value="16sFL">16sFL</option><option value="Olink">Olink</option><option value="10x">10x</option><option value="RADseq">RADseq</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsExpTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>4-1.6 å¯¦é©—å¹³å°</label><select id="ngsPlatformSelect" onchange="handleDropdownChange('ngsPlatformSelect', 'ngsPlatformInput')"><option value="Novaseq X Plus">Novaseq X Plus</option><option value="Miseq">Miseq</option><option value="PacBio">PacBio</option><option value="Nanopore">Nanopore</option><option value="Olink">Olink</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsPlatformInput" placeholder="è¼¸å…¥å¹³å°" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-1.7 è² è²¬æ¥­å‹™</label><select id="ngsSales"></select></div></div><div id="ngs-qc-fields"><div class="ngs-row"><label>4-2.1 æ ¸é…¸ç¨®é¡</label><select id="ngsNucleicTypeSelect" onchange="handleDropdownChange('ngsNucleicTypeSelect', 'ngsNucleicTypeInput'); generateNgsTitle()"><option value="">è«‹é¸æ“‡</option><option value="DNA">DNA</option><option value="RNA">RNA</option><option value="Library">Library</option><option value="miRNA">miRNA</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsNucleicTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;" oninput="generateNgsTitle()"></div><div class="ngs-row"><label>4-2.2 ä¿å­˜æº«åº¦</label><select id="ngsQcTemp"><option value="å¸¸æº«">å¸¸æº«</option><option value="4Â°C">4Â°C</option><option value="-20Â°C">-20Â°C</option><option value="-80Â°C">-80Â°C</option></select></div><div class="ngs-row"><label>4-2.3 æ­¸é‚„</label><select id="ngsQcReturn"><option value="æ˜¯">æ˜¯</option><option value="å¦">å¦</option></select></div><div class="ngs-row"><label>4-2.4 æ¨£æœ¬æ•¸é‡</label><input type="text" id="ngsQcCount" placeholder="å¡«å¯«æ•¸é‡"></div><div class="ngs-row"><label>4-2.5 å¾ŒçºŒå¯¦é©—ç¨®é¡</label><select id="ngsQcExpTypeSelect" onchange="handleDropdownChange('ngsQcExpTypeSelect', 'ngsQcExpTypeInput')"><option value="">è«‹é¸æ“‡</option><option value="Seq Only">Seq Only</option><option value="DGE">DGE</option><option value="Small RNA">Small RNA</option><option value="WES">WES</option><option value="WGS">WGS</option><option value="PIPseq">PIPseq</option><option value="Amplicon Sequence">Amplicon Sequence</option><option value="ç´°èŒWGS">ç´°èŒWGS</option><option value="metagenome">metagenome</option><option value="16s">16s</option><option value="16sFL">16sFL</option><option value="Olink">Olink</option><option value="10x">10x</option><option value="RADseq">RADseq</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsQcExpTypeInput" placeholder="è¼¸å…¥ç¨®é¡" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-2.6 å¯¦é©—å¹³å°</label><select id="ngsQcPlatformSelect" onchange="handleDropdownChange('ngsQcPlatformSelect', 'ngsQcPlatformInput')"><option value="Novaseq X Plus">Novaseq X Plus</option><option value="Miseq">Miseq</option><option value="PacBio">PacBio</option><option value="Nanopore">Nanopore</option><option value="Olink">Olink</option><option value="å…¶ä»–">å…¶ä»– (æ‰‹å‹•è¼¸å…¥)</option></select><input type="text" id="ngsQcPlatformInput" placeholder="è¼¸å…¥å¹³å°" style="display:none; margin-top:5px;"></div><div class="ngs-row"><label>4-2.7 è² è²¬æ¥­å‹™</label><select id="ngsQcSales"></select></div></div></div><div class="input-group"><label>ä»»å‹™å…§å®¹ (é¸å–æ–‡å­—å¯ç·¨è¼¯æ¨£å¼)</label><div class="editor-toolbar"><button class="tool-btn" onclick="formatDoc('bold')" title="ç²—é«”"><b>B</b></button><div class="separator"></div><button class="tool-btn" onclick="formatDoc('foreColor', '#ef4444')" title="ç´…å­—"><span class="color-dot" style="background:#ef4444"></span></button><button class="tool-btn" onclick="formatDoc('foreColor', '#2563eb')" title="è—å­—"><span class="color-dot" style="background:#2563eb"></span></button><button class="tool-btn" onclick="formatDoc('foreColor', '#10b981')" title="ç¶ å­—"><span class="color-dot" style="background:#10b981"></span></button><button class="tool-btn" onclick="formatDoc('foreColor', '#000000')" title="é»‘å­—"><span class="color-dot" style="background:#000000"></span></button><div class="separator"></div><button class="tool-btn" onclick="formatDoc('hiliteColor', '#fecaca')" title="ç´…åº•" style="background:#fecaca">A</button><button class="tool-btn" onclick="formatDoc('hiliteColor', '#bfdbfe')" title="è—åº•" style="background:#bfdbfe">A</button><button class="tool-btn" onclick="formatDoc('hiliteColor', '#bbf7d0')" title="ç¶ åº•" style="background:#bbf7d0">A</button><button class="tool-btn" onclick="formatDoc('hiliteColor', '#ffffff')" title="ç„¡åº•" style="background:#fff">âœ•</button><div class="separator"></div><select class="tool-select" onchange="formatDoc('fontSize', this.value); this.value='';" title="å­—é«”å¤§å°"><option value="">å­—é«”å¤§å°</option><option value="2">å°</option><option value="3">ä¸­</option><option value="5">å¤§</option><option value="7">ç‰¹å¤§</option></select></div><div id="inputTitle" contenteditable="true" placeholder="è¼¸å…¥å…§å®¹..."></div></div><div class="modal-btns"><button class="btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button><button class="btn btn-save" id="btnSaveTask" onclick="saveTask()">ç¢ºèª</button></div></div></div>

<div class="modal-overlay" id="salesSettingsModal"><div class="modal-card" style="width: 450px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">âš™ï¸ NGS è² è²¬æ¥­å‹™è¨­å®š</h3><div style="display:flex; gap:10px; margin-bottom:15px;"><input type="text" id="newSalesName" placeholder="è¼¸å…¥æ–°æ¥­å‹™å§“å" style="flex-grow:1; padding:8px; border:1px solid #ccc; border-radius:4px;"><button class="btn btn-save" onclick="addSalesOption()">æ–°å¢</button></div><ul class="settings-list" id="salesOptionList"></ul><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('salesSettingsModal').style.display='none'">é—œé–‰</button></div></div></div>
<div class="modal-overlay" id="historyModal"><div class="modal-card" style="width: 400px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“‹ ç·¨è¼¯/æ“ä½œç´€éŒ„</h3><ul class="log-list" id="logList"></ul><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('historyModal').style.display='none'">é—œé–‰</button></div></div></div>
<div class="modal-overlay" id="userModal"><div class="modal-card" style="width: 650px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘¥ æˆå“¡æ¬Šé™ç®¡ç†</h3><div style="margin-bottom:10px; text-align:right;"><select id="userFilterSelect" onchange="renderUserList()" style="padding:5px; border-radius:4px; border:1px solid #ddd; font-size:0.85rem;"><option value="all">é¡¯ç¤ºå…¨éƒ¨</option><option value="creator">ğŸŸ£ å‰µä¸–ç¥</option><option value="senior">é«˜ç´šç®¡ç†è€…</option><option value="admin">ç®¡ç†è€…</option><option value="user">ä¸€èˆ¬è€…</option><option value="pending">å¾…å¯©æ ¸</option></select></div><ul class="user-list" id="userListDisplay"></ul><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('userModal').style.display='none'">é—œé–‰</button></div></div></div>
<div class="modal-overlay" id="statsModal"><div class="modal-card" style="width: 700px;"><h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ“Š ä»»å‹™å®Œæˆçµ±æ•´</h3><div class="stats-filter-row"><div><label style="font-size:0.8rem;">é–‹å§‹æ—¥æœŸ</label><input type="date" id="statsDateStart"></div><div><label style="font-size:0.8rem;">çµæŸæ—¥æœŸ</label><input type="date" id="statsDateEnd"></div><div><label style="font-size:0.8rem;">æª¢ç´¢å¸³è™Ÿ</label><select id="statsUserSelect"><option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option></select></div><div style="display:flex; align-items:flex-end;"><button class="btn btn-save" onclick="updateStats()">æŸ¥è©¢</button></div></div><div class="stats-result-area" id="statsResultDisplay"></div><div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('statsModal').style.display='none'">é—œé–‰</button></div></div></div>

<div class="modal-overlay" id="assignSettingsModal">
    <div class="modal-card" style="width: 500px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘¤ æŒ‡æ´¾ä»»å‹™å¸³è™Ÿè¨­å®š</h3>
        <div id="assignRulesContainer"></div>
        <div style="text-align:right; margin-top:15px;"><button class="btn btn-save" onclick="saveAssignmentRules()">å„²å­˜è¨­å®š</button></div>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('assignSettingsModal').style.display='none'">é—œé–‰</button></div>
    </div>
</div>

<div class="modal-overlay" id="assignModal">
    <div class="modal-card" style="width: 350px;">
        <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">ğŸ‘¤ æŒ‡æ´¾ä»»å‹™çµ¦...</h3>
        <ul class="assign-list" id="assignUserList"></ul>
        <div class="modal-btns"><button class="btn btn-cancel" onclick="document.getElementById('assignModal').style.display='none'">å–æ¶ˆ</button></div>
    </div>
</div>

<div id="purModal" class="modal-overlay">
    <div class="modal-card" style="width: 500px;">
        <h3 id="purModalTitle" style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>æ¨™é¡Œ</span>
            <div id="purBatchBtnContainer" style="display:none; gap:5px;">
                <button class="pur-btn-add" onclick="PurchaseController.addBatchInputs(1)">+1</button>
                <button class="pur-btn-add" onclick="PurchaseController.addBatchInputs(5)">+5</button>
                <button class="pur-btn-add" onclick="PurchaseController.addBatchInputs(10)">+10</button>
            </div>
        </h3>
        <div id="purModalBody" style="max-height:60vh; overflow-y:auto; margin-bottom:15px;"></div>
        <div style="text-align:right; border-top:1px solid #eee; padding-top:10px;">
            <button class="btn btn-cancel" onclick="document.getElementById('purModal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-save" id="purModalConfirmBtn">ç¢ºèª</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. FIREBASE INIT (MUST BE TOP)
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyBPcmgaT4f3nfyJrJOXnAeYCwH19SwZvCA",
      authDomain: "tasktrack-app-206f8.firebaseapp.com",
      projectId: "tasktrack-app-206f8",
      storageBucket: "tasktrack-app-206f8.firebasestorage.app",
      messagingSenderId: "528459789330",
      appId: "1:528459789330:web:caca16ee7c2b4efa1754cb",
      measurementId: "G-7JHGQW385H"
    };
    
    let mainApp;
    try { mainApp = firebase.app("mainApp"); } 
    catch(e) { mainApp = firebase.initializeApp(firebaseConfig, "mainApp"); }
    const db = mainApp.firestore();

    const purchaseConfig = {
      apiKey: "AIzaSyDhbjXi1MoVPt2-yIOsB-OZFUtQsqtYvBs",
      authDomain: "realtime-database-ea408.firebaseapp.com",
      databaseURL: "https://realtime-database-ea408-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "realtime-database-ea408",
      storageBucket: "realtime-database-ea408.firebasestorage.app",
      messagingSenderId: "434463345733",
      appId: "1:434463345733:web:1a60ba14b33cf602d7272c"
    };
    
    let purchaseApp;
    try { purchaseApp = firebase.app("purchaseApp"); } 
    catch(e) { purchaseApp = firebase.initializeApp(purchaseConfig, "purchaseApp"); }
    const rtdb = purchaseApp.database();

    // ==========================================
    // 2. GLOBAL VARIABLES & CONSTANTS
    // ==========================================
    const ORDERED_CATEGORIES = ["å®šåºæ”¶ä»¶", "å¼•å­é€ä»¶", "ç”¢å‰æ”¶ä»¶", "æ¥­å‹™äº¤è¾¦äº‹é …", "NGSæ”¶ä»¶"];
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycbw9sCxtJ-rcRLdkwwGJgBCUCKxCFXujD4Ciq_fJxFqbly4Wldb-9nTSE5kqTst16hKg2Q/exec";

    let state = {
        currentUser: null, currentDate: new Date().toISOString().split('T')[0], activeTab: 'tasks',
        tasks: [], users: [], salesOptions: [], customers: [], assignmentRules: {},
        history: JSON.parse(localStorage.getItem('tt_history')||'[]'), editingTaskId: null
    };

    // ==========================================
    // 3. CORE HELPER FUNCTIONS (Globally Accessible)
    // ==========================================
    window.getTodayStr = function() { return new Date().toISOString().split('T')[0]; }
    window.formatDoc = function(cmd, value) { document.execCommand(cmd, false, value); document.getElementById('inputTitle').focus(); }
    window.getUserDisplayName = function(username) { const u = state.users.find(x => x.username === username); return (u && u.nickname) ? u.nickname : username; }
    window.toggleSidebar = function() { document.querySelector('aside').classList.toggle('open'); document.getElementById('sidebar-overlay').classList.toggle('active'); }
    window.copyToClipboard = function(text) { navigator.clipboard.writeText(text).then(() => alert("å·²è¤‡è£½é€šçŸ¥å…§å®¹ï¼")).catch(err => prompt("è«‹æ‰‹å‹•è¤‡è£½:", text)); }

    window.changeDate = function(d, addHistory = true) { 
        state.currentDate = d; 
        document.getElementById('dateSearch').value = d; 
        const dateObj = new Date(d); 
        document.getElementById('headerDateDisplay').innerText = dateObj.toLocaleDateString('zh-TW', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); 
        if(addHistory) { 
            let hist = state.history.filter(x => x !== d); 
            hist.unshift(d); 
            if(hist.length > 10) hist.pop(); 
            state.history = hist; 
            localStorage.setItem('tt_history', JSON.stringify(hist)); 
            renderHistory(); 
        } 
        renderTasks(); 
    }

    window.renderHistory = function() { 
        const ul = document.getElementById('historyList'); 
        ul.innerHTML = ''; 
        state.history.forEach(d => { 
            const li = document.createElement('li'); 
            li.className = `history-item ${d === state.currentDate?'active':''}`; 
            li.innerText = d; 
            li.onclick = () => { changeDate(d, false); if(window.innerWidth<=768) toggleSidebar(); }; 
            ul.appendChild(li); 
        }); 
    }

    window.switchTab = function(tab) {
        state.activeTab = tab;
        document.getElementById('taskView').classList.remove('active'); 
        document.getElementById('customerView').classList.remove('active');
        document.getElementById('purchaseView').classList.remove('active'); 
        
        document.getElementById('btnTabTasks').className = `sidebar-btn ${tab==='tasks'?'btn-nav-active':'btn-nav-inactive'}`;
        document.getElementById('btnTabCustomers').className = `sidebar-btn ${tab==='customers'?'btn-nav-active':'btn-nav-inactive'}`;
        const pBtn = document.getElementById('purchaseBtn');
        if(pBtn) pBtn.className = `admin-btn btn-purchase ${tab==='purchase'?'btn-nav-active':''}`; 

        if (tab === 'tasks') {
            document.getElementById('taskView').classList.add('active');
            if(document.getElementById('taskSearchSection')) document.getElementById('taskSearchSection').style.display = 'block'; 
            document.getElementById('taskDateSection').style.display = 'block';
        } else if (tab === 'customers') {
            document.getElementById('customerView').classList.add('active');
            if(document.getElementById('taskSearchSection')) document.getElementById('taskSearchSection').style.display = 'none'; 
            document.getElementById('taskDateSection').style.display = 'none';
            if(state.customers.length === 0) fetchCustomers();
        } else if (tab === 'purchase') {
            document.getElementById('purchaseView').classList.add('active');
            if(document.getElementById('taskSearchSection')) document.getElementById('taskSearchSection').style.display = 'none'; 
            document.getElementById('taskDateSection').style.display = 'none';
            PurchaseController.init(); 
        }
        if(window.innerWidth <= 768) toggleSidebar();
    }
    
    // ==========================================
    // 4. DATA FETCHING
    // ==========================================
    window.fetchCustomers = async function() {
        document.getElementById('custLoading').style.display = 'block';
        try { const res = await fetch(GAS_API_URL); const data = await res.json(); state.customers = data; } 
        catch (e) { console.error("API Error:", e); alert("è³‡æ–™è®€å–å¤±æ•—"); } 
        finally { document.getElementById('custLoading').style.display = 'none'; }
    }
    
    window.renderCustomers = function(data) {
        const container = document.getElementById('customerList'); container.innerHTML = '';
        if(data.length === 0) { container.innerHTML = '<div style="color:#666; text-align:center;">æŸ¥ç„¡è³‡æ–™</div>'; return; }
        data.forEach(cust => {
            const div = document.createElement('div'); div.className = 'cust-card';
            const name = cust.name||'ç„¡åç¨±'; const unit = cust.unit||'æœªåˆ†é¡';
            const building = cust.building||''; const floor = cust.floor||'';
            let locStr = ''; if(building && floor) locStr = `${building} - ${floor}`; else if(building) locStr = building; else if(floor) locStr = floor;
            const contact = cust.contact||''; const phone = cust.phone||''; const note = cust.note||''; const update = cust.update||'';
            div.innerHTML = `<div class="cust-title-row">${unit} - ${name}</div>${locStr?`<div class="cust-row">ğŸ“ ${locStr}</div>`:''}${contact?`<div class="cust-row">ğŸ‘¤ ${contact}</div>`:''}${phone?`<div class="cust-row">ğŸ“ ${phone}</div>`:''}${note?`<div class="cust-row note">ğŸ“ ${note}</div>`:''}${update?`<div class="cust-update">æœ€å¾Œæ›´æ–°: ${update}</div>`:''}`;
            container.appendChild(div);
        });
    }

    window.handleCustomerSearch = function() {
        const key = document.getElementById('custSearchInput').value.trim().toLowerCase();
        if(!key) { document.getElementById('customerList').innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;margin-top:50px;">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æŸ¥è©¢</div>'; return; }
        const filtered = state.customers.filter(c => JSON.stringify(c).toLowerCase().includes(key));
        renderCustomers(filtered);
    }

    // ==========================================
    // 5. MODAL & SETTINGS FUNCTIONS
    // ==========================================
    window.openSalesSettings = function() {
        const list = document.getElementById('salesOptionList'); list.innerHTML = '';
        state.salesOptions.forEach((opt, index) => { const li = document.createElement('li'); li.className = 'setting-item'; li.innerHTML = `<span>${opt}</span><div><button class="btn-icon" onclick="editSalesOption(${index})">âœï¸</button><button class="btn-icon" style="color:red;" onclick="deleteSalesOption(${index})">ğŸ—‘ï¸</button></div>`; list.appendChild(li); });
        document.getElementById('salesSettingsModal').style.display = 'flex';
    }
    window.saveSalesSettings = function() { db.collection('settings').doc('ngs_sales').update({ list: state.salesOptions }); }
    window.addSalesOption = function() { const val = document.getElementById('newSalesName').value.trim(); if(val) { state.salesOptions.push(val); saveSalesSettings(); document.getElementById('newSalesName').value = ''; } }
    window.deleteSalesOption = function(index) { if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) { state.salesOptions.splice(index, 1); saveSalesSettings(); } }
    window.editSalesOption = function(index) { const newVal = prompt("ä¿®æ”¹:", state.salesOptions[index]); if(newVal && newVal.trim()) { state.salesOptions[index] = newVal.trim(); saveSalesSettings(); } }
    window.populateSalesDropdowns = function() { const optsHtml = state.salesOptions.map(s => `<option value="${s}">${s}</option>`).join(''); const s1 = document.getElementById('ngsSales'); const s2 = document.getElementById('ngsQcSales'); if(s1) s1.innerHTML = optsHtml; if(s2) s2.innerHTML = optsHtml; }

    window.openAssignSettingsModal = function() {
        const container = document.getElementById('assignRulesContainer'); container.innerHTML = '';
        const roleOrder = { 'creator': 0, 'senior': 1, 'admin': 2, 'user': 3 };
        const approvedUsers = state.users.filter(u => u.isApproved).sort((a,b) => (roleOrder[a.role]||4) - (roleOrder[b.role]||4));
        ORDERED_CATEGORIES.forEach(cat => {
            const wrapper = document.createElement('div'); wrapper.className = 'assign-section';
            const currentAllowed = state.assignmentRules[cat] || [];
            let checkboxes = '';
            approvedUsers.forEach(u => {
                const checked = currentAllowed.includes(u.username) ? 'checked' : '';
                const dName = u.nickname || u.username;
                checkboxes += `<label class="assign-check-item"><input type="checkbox" class="assign-checkbox" data-cat="${cat}" data-user="${u.username}" ${checked}> ${dName}</label>`;
            });
            wrapper.innerHTML = `<div class="assign-sec-title">${cat}</div><div class="assign-checkbox-group">${checkboxes}</div>`;
            container.appendChild(wrapper);
        });
        document.getElementById('assignSettingsModal').style.display = 'flex';
    }
    window.saveAssignmentRules = function() {
        const newRules = {};
        ORDERED_CATEGORIES.forEach(cat => {
            const checkedBoxes = Array.from(document.querySelectorAll(`.assign-checkbox[data-cat="${cat}"]:checked`));
            newRules[cat] = checkedBoxes.map(cb => cb.getAttribute('data-user'));
        });
        db.collection('settings').doc('assignment_rules').set(newRules)
          .then(() => { alert('è¨­å®šå·²å„²å­˜'); document.getElementById('assignSettingsModal').style.display='none'; })
          .catch(e => { console.error(e); alert('å„²å­˜å¤±æ•—'); });
    }

    window.openUserModal = function() {
        renderUserList(); 
        document.getElementById('userModal').style.display = 'flex';
    }
    window.renderUserList = function() {
        const list = document.getElementById('userListDisplay'); 
        if(!list) return; 
        const filterRole = document.getElementById('userFilterSelect') ? document.getElementById('userFilterSelect').value : 'all'; 
        list.innerHTML = '';
        const roleOrder = { 'creator': 0, 'senior': 1, 'admin': 2, 'user': 3, 'pending': 4 };
        let displayUsers = [...state.users];
        displayUsers.sort((a,b) => {
            const rA = !a.isApproved ? 4 : (roleOrder[a.role]!==undefined ? roleOrder[a.role] : 3);
            const rB = !b.isApproved ? 4 : (roleOrder[b.role]!==undefined ? roleOrder[b.role] : 3);
            return rA - rB;
        });
        if (filterRole !== 'all') {
            if (filterRole === 'pending') displayUsers = displayUsers.filter(u => !u.isApproved);
            else displayUsers = displayUsers.filter(u => u.isApproved && u.role === filterRole);
        }
        displayUsers.forEach(user => {
            const li = document.createElement('li'); li.className = 'user-item';
            let badgeClass = 'role-user'; let badgeText = 'ä¸€èˆ¬è€…';
            if(user.role === 'creator') { badgeClass = 'role-creator'; badgeText = 'ğŸŸ£ å‰µä¸–ç¥'; }
            else if(user.role === 'senior') { badgeClass = 'role-senior'; badgeText = 'é«˜ç´šç®¡ç†è€…'; }
            else if(user.role === 'admin') { badgeClass = 'role-admin'; badgeText = 'ç®¡ç†è€…'; }
            if(!user.isApproved) { badgeClass = ''; badgeText = 'å¾…å¯©æ ¸'; }
            
            const isTargetCreator = user.role === 'creator';
            const myRole = state.currentUser ? state.currentUser.role : 'user';
            let controlsHtml = '';
            
            if (myRole === 'creator' || myRole === 'senior') {
                if (myRole === 'senior' && isTargetCreator) {
                     controlsHtml = `<div class="user-edit-row"><span style="color:purple; font-weight:bold;">æ­¤ç‚ºæœ€é«˜æ¬Šé™å¸³è™Ÿï¼Œç„¡æ³•ç·¨è¼¯ã€‚</span></div>`;
                } else {
                    const selUser = user.role === 'user' ? 'selected' : '';
                    const selAdmin = user.role === 'admin' ? 'selected' : '';
                    const selSenior = user.role === 'senior' ? 'selected' : '';
                    const roleSelect = (myRole==='creator' && isTargetCreator) ? `<select disabled><option>å‰µä¸–ç¥</option></select>` : `<select id="role_${user.docId}"><option value="user" ${selUser}>ä¸€èˆ¬è€…</option><option value="admin" ${selAdmin}>ç®¡ç†è€…</option><option value="senior" ${selSenior}>é«˜ç´šç®¡ç†è€…</option></select>`;
                    controlsHtml = `<div class="user-edit-row">${roleSelect}<input type="text" id="note_${user.docId}" placeholder="å‚™è¨»" value="${user.remarks || ''}" style="width:50%"><input type="text" id="nick_${user.docId}" placeholder="ç¨±è¬‚ (é¸å¡«)" value="${user.nickname || ''}" style="width:30%"></div>
                        <div class="user-edit-row"><span class="readonly-text">å¯†ç¢¼:</span><input type="password" id="pwd_${user.docId}" value="${user.password}" readonly style="background:#eee;color:#555;"><button class="btn-icon-eye" onclick="togglePasswordVisibility('pwd_${user.docId}')">ğŸ‘ï¸</button></div>
                        <div style="text-align:right;"><button class="btn-approve" onclick="updateUser('${user.docId}')">${user.isApproved?'æ›´æ–°è³‡æ–™':'æ ¸å‡†/æ›´æ–°'}</button>${!isTargetCreator ? `<button class="btn-reject" onclick="deleteUser('${user.docId}')">åˆªé™¤</button>` : ''}</div>`;
                }
            } else {
                let actionBtn = !user.isApproved ? `<button class="btn-approve" onclick="approveUserSimple('${user.docId}')">æ ¸å‡†ç”³è«‹</button>` : `<span style="color:#10b981; font-size:0.85rem;">å·²æ ¸å‡†</span>`;
                controlsHtml = `<div class="user-edit-row"><span class="readonly-text">è§’è‰²: ${badgeText}</span><span class="readonly-text" style="margin-left:15px;">å‚™è¨»: ${user.remarks || '(ç„¡)'}</span></div><div style="text-align:right;">${actionBtn}</div>`;
            }
            li.innerHTML = `<div class="user-header"><div><span class="user-name">${user.username}</span><span class="user-role-badge ${badgeClass}">${badgeText}</span></div></div>${controlsHtml}`;
            list.appendChild(li);
        });
    }

    window.togglePasswordVisibility = function(id) { const input = document.getElementById(id); input.type = input.type === "password" ? "text" : "password"; }
    window.updateUser = function(docId) {
        const role = document.getElementById(`role_${docId}`).value; const note = document.getElementById(`note_${docId}`).value; const nick = document.getElementById(`nick_${docId}`).value;
        db.collection('users').doc(docId).update({ role: role, remarks: note, nickname: nick, isApproved: true }).then(() => alert('è³‡æ–™å·²æ›´æ–°'));
    }
    window.deleteUser = function(docId) { if(confirm('ç¢ºå®šè¦åˆªé™¤ï¼Ÿ')) db.collection('users').doc(docId).delete().then(() => renderUserList()); }
    window.approveUserSimple = function(docId) { db.collection('users').doc(docId).update({ isApproved: true }).then(() => alert('å·²æ ¸å‡†')); }

    window.openStatsModal = function() {
        const modal = document.getElementById('statsModal'); 
        const userSelect = document.getElementById('statsUserSelect'); 
        const startInput = document.getElementById('statsDateStart'); 
        const endInput = document.getElementById('statsDateEnd');
        userSelect.innerHTML = '<option value="all">-- æ‰€æœ‰å¸³è™Ÿ (ç¸½è¦½) --</option>';
        const uniqueUsers = [...new Set(state.tasks.filter(t=>t.completed && t.completedBy).map(t=>t.completedBy))];
        uniqueUsers.sort().forEach(u => { const opt = document.createElement('option'); opt.value = u; opt.innerText = getUserDisplayName(u); userSelect.appendChild(opt); });
        const year = new Date().getFullYear(); 
        startInput.value = `${year}-01-01`; endInput.value = `${year}-12-31`;
        updateStats(); 
        modal.style.display = 'flex';
    }

    window.updateStats = function() {
        const start = document.getElementById('statsDateStart').value; const end = document.getElementById('statsDateEnd').value;
        const selectedUser = document.getElementById('statsUserSelect').value; const display = document.getElementById('statsResultDisplay'); display.innerHTML = '';
        if(!start || !end) return;
        const validTasks = state.tasks.filter(t => !t.completed || t.isDeleted || !t.completedBy ? false : (t.date >= start && t.date <= end));
        if (selectedUser === 'all') {
            const userCounts = {}; let total = 0;
            validTasks.forEach(t => { if(!userCounts[t.completedBy]) userCounts[t.completedBy]=0; userCounts[t.completedBy]++; total++; });
            if(total === 0) { display.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>'; return; }
            Object.entries(userCounts).sort((a,b)=>b[1]-a[1]).forEach(([user, count]) => {
                const pct = Math.round((count/total)*100);
                const card = document.createElement('div'); card.className = 'stat-card';
                card.innerHTML = `<div class="stat-header"><span>${getUserDisplayName(user)}</span> <span>${count} ä»¶</span></div><div class="stat-bar-container"><div class="stat-label"><span>ä½”æ¯”</span><span>${pct}%</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`;
                display.appendChild(card);
            });
        } else {
            const userTasks = validTasks.filter(t => t.completedBy === selectedUser); const total = userTasks.length;
            if(total === 0) { display.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">å¸³è™Ÿ ${getUserDisplayName(selectedUser)} åœ¨æ­¤å€é–“ç„¡å®Œæˆè³‡æ–™</div>`; return; }
            const catCounts = {}; ORDERED_CATEGORIES.forEach(c => catCounts[c]=0);
            userTasks.forEach(t => { if(catCounts[t.category]!==undefined) catCounts[t.category]++; });
            const card = document.createElement('div'); card.className = 'stat-card';
            card.innerHTML = `<div class="stat-header" style="border-bottom:1px solid #eee; padding-bottom:5px;">${getUserDisplayName(selectedUser)} - ç¸½è¨ˆ ${total} ä»¶</div>`;
            ORDERED_CATEGORIES.forEach(cat => {
                const count = catCounts[cat]; const pct = total===0?0:Math.round((count/total)*100);
                card.innerHTML += `<div style="margin-top:10px;"><div class="stat-label"><span>${cat}</span><span>${count} (${pct}%)</span></div><div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div></div>`;
            });
            display.appendChild(card);
        }
    }

    // ==========================================
    // 6. TASK LOGIC (Function Declarations)
    // ==========================================
    window.handleCategoryChange = function() { 
        const cat = document.getElementById('inputCategory').value; 
        document.getElementById('ngs-form-container').style.display = (cat === 'NGSæ”¶ä»¶') ? 'block' : 'none'; 
    }
    
    window.handleNgsNeedsChange = function() {
        const needs = document.getElementById('ngsNeeds').value;
        document.getElementById('ngs-extraction-fields').style.display = (needs === 'èƒå–') ? 'block' : 'none';
        document.getElementById('ngs-qc-fields').style.display = (needs === 'QC') ? 'block' : 'none';
    }
    
    window.handleDropdownChange = function(selectId, inputId) {
        const val = document.getElementById(selectId).value;
        document.getElementById(inputId).style.display = (val === 'å…¶ä»–') ? 'block' : 'none';
    }
    
    window.generateNgsTitle = function() {
        const unit = document.getElementById('ngsUnit').value.trim();
        const pi = document.getElementById('ngsPI').value.trim();
        const needs = document.getElementById('ngsNeeds').value;
        let subType = '';
        if (needs === 'èƒå–') {
            const sel = document.getElementById('ngsExpTypeSelect').value;
            subType = (sel === 'å…¶ä»–') ? document.getElementById('ngsExpTypeInput').value.trim() : sel;
        } else if (needs === 'QC') {
            const sel = document.getElementById('ngsNucleicTypeSelect').value;
            subType = (sel === 'å…¶ä»–') ? document.getElementById('ngsNucleicTypeInput').value.trim() : sel;
        }
        if (unit && pi && subType) {
            document.getElementById('inputTitle').innerText = `${unit}-${pi}-${subType} æ”¶ä»¶`;
        }
    }

    window.openModal = function(taskId=null) { 
        populateSalesDropdowns(); 
        const modal=document.getElementById('taskModal'); 
        const editor=document.getElementById('inputTitle'); 
        document.getElementById('taskModal').style.display='flex'; 
        editor.focus(); 
        document.getElementById('ngs-form-container').style.display = 'none'; 
        document.getElementById('ngsUnit').value = ''; 
        document.getElementById('ngsPI').value = ''; 
        document.getElementById('ngsNeeds').value = ''; 
        document.getElementById('ngs-extraction-fields').style.display = 'none'; 
        document.getElementById('ngs-qc-fields').style.display = 'none'; 
        
        if(taskId) { 
            state.editingTaskId=taskId; 
            const t=state.tasks.find(x=>x.id===taskId); 
            document.getElementById('modalTitle').innerText='ç·¨è¼¯ä»»å‹™å…§å®¹'; 
            editor.innerHTML=t.title; 
            document.getElementById('inputCategory').value=t.category; 
            document.getElementById('btnSaveTask').innerText='ä¿å­˜ä¿®æ”¹'; 
            
            if (t.category === 'NGSæ”¶ä»¶' && t.details) { 
                document.getElementById('ngs-form-container').style.display = 'block'; 
                document.getElementById('ngsUnit').value = t.details.unit || ''; 
                document.getElementById('ngsPI').value = t.details.pi || ''; 
                document.getElementById('ngsNeeds').value = t.details.needs || ''; 
                
                const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val||''; }; 
                const setDropdown = (selId, inpId, val, opts) => { 
                    if(opts.includes(val)) { document.getElementById(selId).value=val; document.getElementById(inpId).style.display='none'; } else { document.getElementById(selId).value='å…¶ä»–'; document.getElementById(inpId).style.display='block'; document.getElementById(inpId).value=val; } 
                }; 
                
                if (t.details.needs === 'èƒå–') { 
                    document.getElementById('ngs-extraction-fields').style.display = 'block'; 
                    setVal('ngsTemp', t.details.temp); 
                    setVal('ngsReturn', t.details.returnBack); 
                    setVal('ngsCount', t.details.sampleCount); 
                    setVal('ngsSales', t.details.sales); 
                    setDropdown('ngsSampleTypeSelect', 'ngsSampleTypeInput', t.details.sampleType, ['Cell','Blood','Tissue','Plant']); 
                    setDropdown('ngsExpTypeSelect', 'ngsExpTypeInput', t.details.expType, ['Seq Only','DGE','Small RNA','WES','WGS','PIPseq','Amplicon Sequence','ç´°èŒWGS','metagenome','16s','16sFL','Olink','10x','RADseq']); 
                    setDropdown('ngsPlatformSelect', 'ngsPlatformInput', t.details.platform, ['Novaseq X Plus','Miseq','PacBio','Nanopore','Olink']); 
                } else if (t.details.needs === 'QC') { 
                    document.getElementById('ngs-qc-fields').style.display = 'block'; 
                    setVal('ngsQcTemp', t.details.temp); 
                    setVal('ngsQcReturn', t.details.returnBack); 
                    setVal('ngsQcCount', t.details.sampleCount); 
                    setVal('ngsQcSales', t.details.sales); 
                    setDropdown('ngsNucleicTypeSelect', 'ngsNucleicTypeInput', t.details.nucleicType, ['DNA','RNA','Library','miRNA']); 
                    setDropdown('ngsQcExpTypeSelect', 'ngsQcExpTypeInput', t.details.expType, ['Seq Only','DGE','Small RNA','WES','WGS','PIPseq','Amplicon Sequence','ç´°èŒWGS','metagenome','16s','16sFL','Olink','10x','RADseq']); 
                    setDropdown('ngsQcPlatformSelect', 'ngsQcPlatformInput', t.details.platform, ['Novaseq X Plus','Miseq','PacBio','Nanopore','Olink']); 
                } 
            } 
        } else { 
            state.editingTaskId=null; 
            document.getElementById('modalTitle').innerText='æ–°å¢æ¡ˆä»¶/ä»»å‹™'; 
            editor.innerHTML=''; 
            document.getElementById('btnSaveTask').innerText='ç¢ºèªæ–°å¢'; 
            document.getElementById('inputCategory').value = 'å®šåºæ”¶ä»¶'; 
        } 
    }
    
    window.closeModal = function() { document.getElementById('taskModal').style.display='none'; state.editingTaskId=null; }

    window.saveTask = function() { 
        const htmlContent = document.getElementById('inputTitle').innerHTML.trim(); const category = document.getElementById('inputCategory').value;
        const textContent = document.getElementById('inputTitle').innerText.trim();
        if(textContent === '' && !htmlContent.includes('<img')) return alert('è«‹è¼¸å…¥ä»»å‹™å…§å®¹');
        let details = null;
        if (category === 'NGSæ”¶ä»¶') {
            const unit = document.getElementById('ngsUnit').value.trim(); const pi = document.getElementById('ngsPI').value.trim(); const needs = document.getElementById('ngsNeeds').value;
            if (!unit || !pi || !needs) return alert('è«‹å®Œæ•´å¡«å¯« NGS è©³ç´°è³‡æ–™');
            details = { unit, pi, needs };
            if (needs === 'èƒå–' || needs === 'QC') {
                const prefix = needs === 'èƒå–' ? 'ngs' : 'ngsQc';
                if (needs === 'èƒå–') { details.sampleType = getDropdownOrInput('ngsSampleTypeSelect', 'ngsSampleTypeInput'); if (!details.sampleType) return alert('è«‹å¡«å¯«æª¢é«”ç¨®é¡'); }
                else { details.nucleicType = getDropdownOrInput('ngsNucleicTypeSelect', 'ngsNucleicTypeInput'); if (!details.nucleicType) return alert('è«‹å¡«å¯«æ ¸é…¸ç¨®é¡'); }
                details.temp = document.getElementById(prefix + 'Temp').value; details.returnBack = document.getElementById(prefix + 'Return').value;
                details.sampleCount = document.getElementById(prefix + 'Count').value.trim(); details.expType = getDropdownOrInput(prefix + 'ExpTypeSelect', prefix + 'ExpTypeInput');
                details.platform = getDropdownOrInput(prefix + 'PlatformSelect', prefix + 'PlatformInput'); details.sales = document.getElementById(prefix + 'Sales').value;
                if (!details.sampleCount || !details.expType || !details.platform) return alert('è«‹å®Œæ•´å¡«å¯«è©³ç´°è³‡æ–™');
            }
        }
        if(state.editingTaskId) { updateTaskDb(state.editingTaskId, { title: htmlContent, category: category, details: details }, 'ä¿®æ”¹', 'ç·¨è¼¯ä»»å‹™å…§å®¹/åˆ†é¡'); } 
        else { const newTask = { title: htmlContent, category: category, date: state.currentDate, completed: false, isDeleted: false, logs: [], createdAt: new Date().toISOString(), details: details }; newTask.logs.push({ type: 'å»ºç«‹', desc: `å»ºç«‹ä»»å‹™æ–¼ [${category}]`, user: state.currentUser.name, time: new Date().toISOString() }); db.collection('tasks').add(newTask); }
        closeModal();
    }

    window.getDropdownOrInput = function(selectId, inputId) { const sel = document.getElementById(selectId).value; return (sel === 'å…¶ä»–') ? document.getElementById(inputId).value.trim() : sel; }
    window.updateTaskDb = function(id, data, logType, logDesc) { const task = state.tasks.find(t => t.id === id); const newLogs = task.logs || []; newLogs.unshift({ type: logType, desc: logDesc, user: state.currentUser.name, time: new Date().toISOString() }); db.collection('tasks').doc(id).update({ ...data, logs: newLogs }); }
    window.toggleTask = function(id) { const task = state.tasks.find(t => t.id === id); if(task) { const newVal = !task.completed; updateTaskDb(id, { completed: newVal, completedBy: newVal ? state.currentUser.name : null, completedAt: newVal ? new Date().toISOString() : null }, newVal ? 'å®Œæˆ' : 'é‡å•Ÿ', newVal ? 'æ¨™è¨˜ç‚ºå®Œæˆ' : 'å–æ¶ˆå®Œæˆç‹€æ…‹'); } }
    window.restoreTask = function(id) { updateTaskDb(id, { isDeleted: false }, 'é‚„åŸ', 'å¾åˆªé™¤é …ç›®ä¸­é‚„åŸ'); }
    window.deleteTask = function(id) { if(confirm('ç§»è‡³è¢«åˆªé™¤é …ç›®ï¼Ÿ')) updateTaskDb(id, { isDeleted: true }, 'åˆªé™¤', 'ç§»è‡³è¢«åˆªé™¤é …ç›®'); }
    window.showHistory = function(id) { const t = state.tasks.find(x=>x.id===id); if(!t) return; const list = document.getElementById('logList'); list.innerHTML=''; (t.logs||[]).forEach(l => { const d=new Date(l.time); const timeStr=`${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`; const userDisp = getUserDisplayName(l.user); list.innerHTML+=`<li class="log-item"><div class="log-time">${timeStr}</div><div class="log-content"><span class="log-user">${userDisp}</span> ${l.desc}</div></li>`; }); document.getElementById('historyModal').style.display='flex'; }

    window.openAssignModal = function(taskId, category) {
        assigningTaskId = taskId; const list = document.getElementById('assignUserList'); list.innerHTML = '';
        const allowedUsers = state.assignmentRules[category] || [];
        let targetUsers = [];
        if (allowedUsers.length > 0) targetUsers = state.users.filter(u => allowedUsers.includes(u.username));
        else targetUsers = state.users.filter(u => u.isApproved);
        if (targetUsers.length === 0) { list.innerHTML = '<li style="padding:10px; color:#666;">ç„¡å¯ç”¨æŒ‡æ´¾å°è±¡ï¼Œè«‹è‡³å¾Œå°è¨­å®šã€‚</li>'; }
        targetUsers.forEach(u => {
            const li = document.createElement('li'); li.className = 'user-item'; li.style.cursor = 'pointer';
            const dName = u.nickname || u.username;
            li.innerHTML = `<div style="font-weight:bold; width:100%; padding:5px;" onclick="confirmAssign('${u.username}')">${dName}</div>`;
            list.appendChild(li);
        });
        document.getElementById('assignModal').style.display = 'flex';
    }
    
    window.confirmAssign = function(username) {
        if(!assigningTaskId) return;
        updateTaskDb(assigningTaskId, { assignedTo: username }, 'æŒ‡æ´¾', `æŒ‡æ´¾çµ¦ ${getUserDisplayName(username)}`);
        document.getElementById('assignModal').style.display = 'none'; assigningTaskId = null;
    }

    window.openImportModal = function() {
        const select = document.getElementById('importCategorySelect'); select.innerHTML = '';
        ORDERED_CATEGORIES.forEach(cat => { if (cat !== 'NGSæ”¶ä»¶') { const opt = document.createElement('option'); opt.value = cat; opt.innerText = cat; select.appendChild(opt); } });
        document.getElementById('importModal').style.display = 'flex'; document.getElementById('importTextarea').value = '';
    }
    
    window.processImport = async function() {
        const raw = document.getElementById('importTextarea').value.trim(); const cat = document.getElementById('importCategorySelect').value;
        if(!raw) return alert("è«‹è¼¸å…¥å…§å®¹");
        const lines = raw.split('\n'); let successCount = 0;
        for (let i = 0; i < lines.length; i++) {
            const title = lines[i].trim(); if(!title) continue;
            try { await db.collection('tasks').add({ category: cat, title: title, details: null, date: state.currentDate, completed: false, isDeleted: false, logs: [{ type: 'åŒ¯å…¥', desc: 'æ‰¹é‡åŒ¯å…¥', user: state.currentUser.name, time: new Date().toISOString() }], createdAt: new Date().toISOString() }); successCount++; } catch(e) { console.error(e); }
        }
        alert(`åŒ¯å…¥å®Œæˆï¼æˆåŠŸ: ${successCount}`); document.getElementById('importModal').style.display = 'none';
    }

    window.handleSearch = function() {
        const input = document.getElementById('searchTaskInput');
        const list = document.getElementById('searchResults');
        const val = input.value.trim().toLowerCase();
        list.innerHTML = ''; list.style.display = 'none';
        if (!val) return;
        const matches = state.tasks.filter(t => {
            const rawTitle = t.title ? t.title.replace(/<[^>]+>/g, '') : '';
            return rawTitle.toLowerCase().includes(val);
        });
        if (matches.length > 0) {
            list.style.display = 'block';
            matches.sort((a,b) => new Date(b.date) - new Date(a.date));
            matches.slice(0, 20).forEach(t => {
                const li = document.createElement('li'); li.className = 'search-item';
                const rawTitle = t.title.replace(/<[^>]+>/g, '');
                li.innerHTML = `<div style="font-weight:bold;">${rawTitle}</div><div style="font-size:0.8rem; color:#666;">ğŸ“… ${t.date}</div>`;
                li.onclick = () => { changeDate(t.date); input.value = ''; list.style.display = 'none'; if(window.innerWidth <= 768) toggleSidebar(); };
                list.appendChild(li);
            });
        } else { list.style.display = 'block'; list.innerHTML = '<li style="padding:10px; color:#999; text-align:center;">ç„¡ç¬¦åˆçµæœ</li>'; }
    }

    // ==========================================
    // 7. AUTH & UI INIT
    // ==========================================
    window.handleAuth = async function() {
        const u = document.getElementById('username').value.trim(); const p = document.getElementById('password').value.trim();
        const title = document.getElementById('auth-title').innerText; const btn = document.getElementById('btnAuthAction');
        if(!u || !p) return alert('è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼'); btn.disabled = true;
        try {
            if (title.includes('è¨»å†Š')) {
                if (u.toLowerCase() === 'admin') throw new Error('ä¸å¯ä½¿ç”¨ Admin ä½œç‚ºå¸³è™Ÿ');
                const q = await db.collection('users').where('username', '==', u).get(); if (!q.empty) throw new Error('å¸³è™Ÿå·²å­˜åœ¨');
                await db.collection('users').add({ username: u, password: p, isApproved: false, role: 'user', remarks: '', nickname: '' });
                alert('è¨»å†ŠæˆåŠŸï¼å¾…ç®¡ç†å“¡æ ¸å‡†å¾Œæ–¹å¯ç™»å…¥ã€‚'); toggleAuthMode();
            } else {
                if (u === 'Admin' && p === 'Abcd1234') {
                    const q = await db.collection('users').where('username', '==', 'Admin').get();
                    if(q.empty) await db.collection('users').add({ username: 'Admin', password: p, isApproved: true, role: 'creator', remarks: 'å‰µä¸–ç¥', nickname: 'ç³»çµ±ç®¡ç†å“¡' });
                    loginSuccess('Admin', 'creator');
                } else {
                    const q = await db.collection('users').where('username', '==', u).where('password', '==', p).get();
                    if (q.empty) alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); else { const user = q.docs[0].data(); if (!user.isApproved) alert('âš ï¸ æ‚¨çš„å¸³è™Ÿå°šæœªé€šéå¯©æ ¸ã€‚'); else loginSuccess(user.username, user.role || 'user'); }
                }
            }
        } catch (e) { alert(e.message || 'ç™¼ç”ŸéŒ¯èª¤'); console.error(e); } finally { btn.disabled = false; }
    }
    
    window.toggleAuthMode = function() {
        const title = document.getElementById('auth-title'); const btn = document.getElementById('btnAuthAction'); const link = document.getElementById('switchAuthLink');
        if (title.innerText.includes('ç™»å…¥')) { title.innerText = 'è¨»å†Šæ–°å¸³è™Ÿ'; btn.innerText = 'è¨»å†Š'; link.innerText = 'å·²æœ‰å¸³è™Ÿï¼Ÿç™»å…¥'; } 
        else { title.innerText = 'ç³»çµ±ç™»å…¥'; btn.innerText = 'ç™»å…¥'; link.innerText = 'æ²’æœ‰å¸³è™Ÿï¼Ÿè¨»å†Šæ–°å¸³è™Ÿ'; }
    }

    window.loginSuccess = function(username, role) { state.currentUser = { name: username, role: role }; localStorage.setItem('tt_current_user', JSON.stringify(state.currentUser)); initApp(); }
    window.logout = function() { localStorage.removeItem('tt_current_user'); location.reload(); }

    window.initApp = function() { 
        document.getElementById('auth-screen').style.display = 'none'; 
        document.getElementById('app-screen').style.display = 'flex'; 
        updateUIForRole(); 
        changeDate(state.currentDate, false); 
    }

    window.updateUIForRole = function() {
        if(!state.currentUser) return;
        let roleName = '';
        if(state.currentUser.role === 'creator') roleName = ' (å‰µä¸–ç¥)'; else if(state.currentUser.role === 'senior') roleName = ' (é«˜ç´šç®¡ç†è€…)'; else if(state.currentUser.role === 'admin') roleName = ' (ç®¡ç†è€…)';
        const dispName = getUserDisplayName(state.currentUser.name);
        document.getElementById('displayUsername').innerText = dispName + roleName; document.getElementById('userAvatar').innerText = dispName[0].toUpperCase();
        
        const canViewPurchase = ['creator', 'senior', 'admin'].includes(state.currentUser.role);
        document.getElementById('purchaseBtn').style.display = canViewPurchase ? 'block' : 'none';

        const canManage = ['creator','senior','admin'].includes(state.currentUser.role);
        const canConfig = ['creator','senior'].includes(state.currentUser.role);
        document.getElementById('adminPanelBtn').style.display = canManage ? 'block' : 'none';
        document.getElementById('statsPanelBtn').style.display = canConfig ? 'block' : 'none';
        document.getElementById('salesSettingsBtn').style.display = canConfig ? 'block' : 'none';
        document.getElementById('assignSettingsBtn').style.display = canConfig ? 'block' : 'none'; 
        document.getElementById('importBtn').style.display = canManage ? 'block' : 'none'; 
    }
    
    // ==========================================
    // 8. PURCHASE CONTROLLER
    // ==========================================
    const PurchaseController = {
        filterYear: 'All', filterStatus: 'All',
        init: () => {
            document.getElementById('purTableBody').innerHTML = '<tr><td colspan="8">è³‡æ–™è®€å–ä¸­...</td></tr>';
            const ref = rtdb.ref('purchaseOrders');
            ref.on('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    const list = Object.keys(val).map(key => ({ ...val[key], firebaseKey: key }));
                    PurchaseService._localData = list.reverse();
                    PurchaseController.renderTable();
                } else {
                    PurchaseService._localData = [];
                    PurchaseController.renderTable();
                }
            });
        },
        renderTable: () => {
            const tbody = document.getElementById('purTableBody');
            const searchVal = document.getElementById('purSearchInput').value.toUpperCase();
            const filterDisplay = document.getElementById('purActiveFilterDisplay');
            if(PurchaseController.filterYear !== 'All' || PurchaseController.filterStatus !== 'All') {
                filterDisplay.style.display = 'inline-block';
                filterDisplay.innerText = `ç¯©é¸: ${PurchaseController.filterYear} / ${PurchaseController.filterStatus}`;
            } else { filterDisplay.style.display = 'none'; }
            
            tbody.innerHTML = '';
            const data = PurchaseService._localData;
            if (data.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="color:#888;">ç„¡è³‡æ–™</td></tr>'; return; }
            
            data.forEach((item, index) => {
                if (searchVal && !item.id.toUpperCase().includes(searchVal)) return;
                if (PurchaseController.filterStatus !== "All" && item.status !== PurchaseController.filterStatus) return;
                if (PurchaseController.filterYear !== "All" && !item.createDate.startsWith(PurchaseController.filterYear)) return;
                tbody.innerHTML += PurchaseService.createRowHtml(item, index);
            });
        },
        openModal: (action, index) => { PurchaseService.showModal(action, index); },
        addBatchInputs: (count) => { 
            const area = document.getElementById('purBatchInputArea');
            for(let i=0; i<count; i++) {
                const input = document.createElement('input');
                input.type = 'text'; input.className = 'pur-input-group pur-batch-field'; input.style.marginBottom="5px"; input.style.width="100%"; input.placeholder = 'ä¾‹å¦‚ï¼šA2026-001';
                area.appendChild(input);
            }
        }
    };
    
    const PurchaseService = {
        _localData: [],
        createRowHtml: (item, index) => {
            const isCancelled = (item.status === 'æ¡è³¼å–æ¶ˆ');
            const rowClass = isCancelled ? "row-cancelled" : "";
            let badgeClass = "";
            switch(item.status) {
                case 'æ–°å»ºç«‹': badgeClass = "st-new"; break;
                case 'å·²å¡«PUR': badgeClass = "st-pur"; break;
                case 'å·²å¡«SAP': badgeClass = "st-sap"; break;
                case 'å·²ä¸‹å–®': badgeClass = "st-ordered"; break;
                case 'æ¡è³¼å–æ¶ˆ': badgeClass = "st-cancel"; break;
                default: badgeClass = "st-new";
            }
            let buttonsHtml = "";
            if (isCancelled) {
                 buttonsHtml = `<button class="pur-btn-base pur-btn-sm pur-btn-restore" onclick="PurchaseController.openModal('restore', ${index})">â™»ï¸ æ¢å¾©</button>`;
            } else {
                 let mainBtn = "";
                 if (item.status === 'æ–°å»ºç«‹') mainBtn = `<button class="pur-btn-base pur-btn-sm pur-btn-action" onclick="PurchaseController.openModal('fillPur', ${index})">å¡«å¯« PUR</button>`;
                 else if (item.status === 'å·²å¡«PUR') mainBtn = `<button class="pur-btn-base pur-btn-sm pur-btn-action" onclick="PurchaseController.openModal('fillSap', ${index})">å¡«å¯« SAP</button>`;
                 else if (item.status === 'å·²å¡«SAP') mainBtn = `<button class="pur-btn-base pur-btn-sm pur-btn-final" onclick="PurchaseController.openModal('confirmOrder', ${index})">âœ… ä¸‹å–®</button>`;
                 else if (item.status === 'å·²ä¸‹å–®') mainBtn = `<button class="pur-btn-base pur-btn-sm pur-btn-revert" onclick="PurchaseController.openModal('revertOrder', ${index})">â†©ï¸ é€€å›</button>`;
                 
                 let noteBtn = `<button class="pur-btn-base pur-btn-sm pur-btn-note" onclick="PurchaseController.openModal('editNote', ${index})">ğŸ“</button>`;
                 buttonsHtml = `<div style="display:flex;gap:5px;justify-content:center;">${mainBtn}${noteBtn}<button class="pur-btn-base pur-btn-sm pur-btn-modify" onclick="PurchaseController.openModal('modify', ${index})">ğŸ› </button><button class="pur-btn-base pur-btn-sm pur-btn-delete" onclick="PurchaseController.openModal('delete', ${index})">ğŸ—‘ï¸</button></div>`;
            }
            
            const logText = (item.logs || []).join("\n");
            let iconsHtml = `<div class="tooltip-container">ğŸ“<span class="tooltip-text">${logText}</span></div>`;
            if (item.note && item.note.trim() !== "") {
                iconsHtml += `<div class="tooltip-container"><span class="note-icon">!</span><span class="tooltip-text">${item.note}</span></div>`;
            }

            let orderDisplay = item.ordered.val||'--';
            if (item.ordered.qOrder) {
                orderDisplay += `<div style="color:#d35400;font-size:0.85rem;margin-top:4px;font-weight:bold;">${item.ordered.qOrder}</div>`;
            }

            return `<tr class="${rowClass}">
                <td>${item.createDate}</td>
                <td>${iconsHtml}</td>
                <td><strong>${item.id}</strong></td>
                <td>${item.pur.val||'--'}</td>
                <td>${item.sap.val||'--'}</td>
                <td>${orderDisplay}</td>
                <td><div class="pur-badge ${badgeClass}">${item.status}</div></td>
                <td>${buttonsHtml}</td>
            </tr>`;
        },
        showModal: (action, index) => {
            const modal = document.getElementById('purModal');
            const title = document.getElementById('purModalTitle').querySelector('span');
            const body = document.getElementById('purModalBody');
            const btn = document.getElementById('purModalConfirmBtn');
            const batchBtns = document.getElementById('purBatchBtnContainer');
            const item = (index !== undefined) ? PurchaseService._localData[index] : null;
            const currentUser = getUserDisplayName(state.currentUser?.name || 'Unknown');
            const timeStr = new Date().toLocaleString('zh-TW', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'});

            modal.style.display = 'flex';
            batchBtns.style.display = 'none';
            btn.className = "btn btn-save"; 

            if (action === 'add') {
                title.innerText = "æ–°å¢æ¡è³¼è¨‚å–®";
                batchBtns.style.display = "flex";
                body.innerHTML = `<div class="modal-label" style="margin-bottom:10px;">è¼¸å…¥ç·¨è™Ÿ (å¯å¤šç­†)ï¼š</div><div id="purBatchInputArea"><input type="text" class="pur-input-group pur-batch-field" style="width:100%;margin-bottom:5px;" placeholder="ä¾‹å¦‚ï¼šA2026-001"></div>`;
                btn.innerText = "ç¢ºèªæ–°å¢";
                btn.onclick = () => {
                    const inputs = document.querySelectorAll('.pur-batch-field');
                    let count = 0;
                    inputs.forEach(inp => {
                        const val = inp.value.trim();
                        if(val) {
                            rtdb.ref('purchaseOrders').push({
                                id: val, createDate: getTodayStr().replace(/-/g,'/'), timestamp: Date.now(),
                                pur: {val:"", time:""}, sap: {val:"", time:""}, ordered: {val:"", time:""},
                                status: 'æ–°å»ºç«‹', logs: [`${timeStr} - ${currentUser} - å»ºç«‹è¨‚å–® (${val})`]
                            });
                            count++;
                        }
                    });
                    if(count>0) modal.style.display='none';
                };
            } else if (action === 'fillPur') {
                title.innerText = "å¡«å¯« PUR å–®è™Ÿ";
                body.innerHTML = `<div class="pur-input-group"><label>PUR å–®è™Ÿï¼š</label><input type="text" id="pInput" class="modal-input" value="${item.pur.val}" autofocus></div>`;
                btn.innerText = "å„²å­˜";
                btn.onclick = () => {
                    const val = document.getElementById('pInput').value;
                    if(val) {
                        const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - å¡«å¯«PUR: ${val}`];
                        rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ pur: {val:val, time:timeStr}, status:'å·²å¡«PUR', logs: newLogs });
                        modal.style.display='none';
                    }
                };
            } else if (action === 'fillSap') {
                title.innerText = "å¡«å¯« SAP å–®è™Ÿ";
                body.innerHTML = `<div class="pur-input-group"><label>SAP å–®è™Ÿï¼š</label><input type="text" id="pInput" class="modal-input" value="${item.sap.val}" autofocus></div>`;
                btn.innerText = "å„²å­˜";
                btn.onclick = () => {
                    const val = document.getElementById('pInput').value;
                    if(val) {
                        const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - å¡«å¯«SAP: ${val}`];
                        rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ sap: {val:val, time:timeStr}, status:'å·²å¡«SAP', logs: newLogs });
                        modal.style.display='none';
                    }
                };
            } else if (action === 'confirmOrder') {
                title.innerText = "æœ€çµ‚ä¸‹å–®ç¢ºèª";
                body.innerHTML = `
                    <div style="text-align:center; padding-bottom:10px; font-size:1.1rem;">ç¢ºå®š <b>${item.id}</b> å·²å®Œæˆä¸‹å–®ï¼Ÿ</div>
                    <div class="pur-input-group">
                        <label>QIAGEN å–®è™Ÿ (å¿…å¡«)</label>
                        <input type="text" id="qOrderInput" placeholder="è«‹è¼¸å…¥å–®è™Ÿ..." autofocus>
                    </div>
                `;
                btn.innerText = "ç¢ºèªä¸‹å–®";
                btn.onclick = () => {
                    const qOrder = document.getElementById('qOrderInput').value.trim();
                    if(!qOrder) return alert("è«‹è¼¸å…¥ QIAGEN å–®è™Ÿ");
                    const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - ç¢ºèªå·²ä¸‹å–® (å–®è™Ÿ:${qOrder})`];
                    rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ ordered: {val:'å·²ä¸‹å–®', time:timeStr, qOrder: qOrder}, status:'å·²ä¸‹å–®', logs: newLogs });
                    modal.style.display='none';
                };
            } else if (action === 'editNote') {
                title.innerText = "ç·¨è¼¯å‚™è¨»";
                body.innerHTML = `<div class="pur-input-group"><label>å‚™è¨»å…§å®¹ï¼š</label><textarea id="noteInput" style="height:100px;">${item.note || ''}</textarea></div>`;
                btn.innerText = "å„²å­˜å‚™è¨»";
                btn.onclick = () => {
                    const noteVal = document.getElementById('noteInput').value.trim();
                    rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ note: noteVal });
                    modal.style.display='none';
                };
            } else if (action === 'delete') {
                title.innerText = "åˆªé™¤ç¢ºèª";
                body.innerHTML = `<div style="color:#ef4444; font-weight:bold; text-align:center; padding:20px;">ç¢ºå®šè¦åˆªé™¤ ${item.id} å—ï¼Ÿ</div>`;
                btn.innerText = "ç¢ºèªåˆªé™¤";
                btn.style.backgroundColor = "#ef4444";
                btn.onclick = () => {
                    const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - åˆªé™¤`];
                    rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ status:'æ¡è³¼å–æ¶ˆ', logs: newLogs });
                    modal.style.display='none';
                };
            } else if (action === 'restore') {
                title.innerText = "æ¢å¾©æ¡è³¼";
                body.innerHTML = `<div style="color:#10b981; font-weight:bold; text-align:center; padding:20px;">ç¢ºå®šæ¢å¾© ${item.id}ï¼Ÿ</div>`;
                btn.innerText = "æ¢å¾©";
                btn.onclick = () => {
                    let s = 'æ–°å»ºç«‹';
                    if(item.ordered.val) s='å·²ä¸‹å–®'; else if(item.sap.val) s='å·²å¡«SAP'; else if(item.pur.val) s='å·²å¡«PUR';
                    const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - æ¢å¾©æ¡è³¼`];
                    rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ status:s, logs: newLogs });
                    modal.style.display='none';
                };
            } else if (action === 'modify') {
                title.innerText = "ä¿®æ”¹è³‡æ–™";
                body.innerHTML = `
                    <div class="pur-input-group"><label>ç·¨è™Ÿ</label><input id="mId" class="modal-input" value="${item.id}"></div>
                    <div class="pur-input-group"><label>PUR</label><input id="mPur" class="modal-input" value="${item.pur.val}"></div>
                    <div class="pur-input-group"><label>SAP</label><input id="mSap" class="modal-input" value="${item.sap.val}"></div>
                `;
                btn.innerText = "å„²å­˜ä¿®æ”¹";
                btn.onclick = () => {
                    const nId = document.getElementById('mId').value;
                    const nPur = document.getElementById('mPur').value;
                    const nSap = document.getElementById('mSap').value;
                    const changes = [];
                    if(nId!==item.id) changes.push(`ID: ${item.id}->${nId}`);
                    if(nPur!==item.pur.val) changes.push(`PUR: ${item.pur.val}->${nPur}`);
                    if(nSap!==item.sap.val) changes.push(`SAP: ${item.sap.val}->${nSap}`);
                    if(changes.length>0) {
                        const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - ä¿®æ”¹: ${changes.join(',')}`];
                        rtdb.ref('purchaseOrders/'+item.firebaseKey).update({
                            id: nId, pur: {...item.pur, val:nPur}, sap: {...item.sap, val:nSap}, logs: newLogs
                        });
                    }
                    modal.style.display='none';
                };
            } else if (action === 'revertOrder') {
                title.innerText = "å–æ¶ˆä¸‹å–®";
                body.innerHTML = `<div style="text-align:center; padding:20px;">ç¢ºå®šå°‡ ${item.id} é€€å›æœªä¸‹å–®ç‹€æ…‹ï¼Ÿ</div>`;
                btn.innerText = "ç¢ºèªé€€å›";
                btn.onclick = () => {
                    let s = 'æ–°å»ºç«‹';
                    if(item.sap.val) s='å·²å¡«SAP'; else if(item.pur.val) s='å·²å¡«PUR';
                    const newLogs = [...(item.logs||[]), `${timeStr} - ${currentUser} - é€€å›ä¸‹å–®ç‹€æ…‹`];
                    rtdb.ref('purchaseOrders/'+item.firebaseKey).update({ ordered:{val:'', time:'', qOrder:''}, status:s, logs: newLogs });
                    modal.style.display='none';
                };
            } else if (action === 'filter') {
                title.innerText = "ç¯©é¸æ¢ä»¶";
                body.innerHTML = `
                    <div class="pur-input-group"><label>å¹´åº¦</label><select id="pfYear" class="modal-select"><option value="All">å…¨éƒ¨</option><option value="2025">2025</option><option value="2026">2026</option></select></div>
                    <div class="pur-input-group"><label>ç‹€æ…‹</label><select id="pfStatus" class="modal-select"><option value="All">å…¨éƒ¨</option><option value="æ–°å»ºç«‹">æ–°å»ºç«‹</option><option value="å·²å¡«PUR">å·²å¡«PUR</option><option value="å·²å¡«SAP">å·²å¡«SAP</option><option value="å·²ä¸‹å–®">å·²ä¸‹å–®</option><option value="æ¡è³¼å–æ¶ˆ">æ¡è³¼å–æ¶ˆ</option></select></div>
                `;
                document.getElementById('pfYear').value = PurchaseController.filterYear;
                document.getElementById('pfStatus').value = PurchaseController.filterStatus;
                btn.innerText = "å¥—ç”¨";
                btn.onclick = () => {
                    PurchaseController.filterYear = document.getElementById('pfYear').value;
                    PurchaseController.filterStatus = document.getElementById('pfStatus').value;
                    PurchaseController.renderTable();
                    modal.style.display='none';
                };
            }
        }
    };
    
    // ==========================================
    // 9. STARTUP & LISTENERS
    // ==========================================
    const storedUser = localStorage.getItem('tt_current_user');
    if(storedUser) { 
        state.currentUser = JSON.parse(storedUser); 
        initApp(); 
    }

    // Attach Listeners
    db.collection('tasks').onSnapshot(snapshot => {
        state.tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if(state.activeTab === 'tasks') renderTasks();
    });
    db.collection('users').onSnapshot(snapshot => {
        state.users = snapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));
        if(document.getElementById('userModal').style.display === 'flex') renderUserList();
    });
    db.collection('settings').doc('ngs_sales').onSnapshot(doc => {
        if(doc.exists) state.salesOptions = doc.data().list || ['Jeff', 'å»–è»’é€µ'];
        else { state.salesOptions = ['Jeff', 'å»–è»’é€µ']; db.collection('settings').doc('ngs_sales').set({ list: state.salesOptions }); }
    });
    db.collection('settings').doc('assignment_rules').onSnapshot(doc => { 
        state.assignmentRules = doc.exists ? doc.data() : {}; 
    });

</script>
</body>
</html>
